<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Blockchain Graph Analysis</title>
  <!-- Sigma core -->
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/sigma.core.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/conrad.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/utils/sigma.utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/utils/sigma.polyfills.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/sigma.settings.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/classes/sigma.classes.dispatcher.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/classes/sigma.classes.configurable.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/classes/sigma.classes.graph.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/classes/sigma.classes.camera.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/classes/sigma.classes.quad.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/classes/sigma.classes.edgequad.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/captors/sigma.captors.mouse.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/captors/sigma.captors.touch.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/sigma.renderers.canvas.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/sigma.renderers.webgl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/sigma.renderers.svg.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/sigma.renderers.def.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.labels.def.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.hovers.def.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.nodes.def.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.edges.def.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.edges.curve.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.edges.arrow.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.edges.curvedArrow.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.edgehovers.def.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.edgehovers.curve.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.edgehovers.arrow.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.edgehovers.curvedArrow.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/renderers/canvas/sigma.canvas.extremities.def.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/middlewares/sigma.middlewares.rescale.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/middlewares/sigma.middlewares.copy.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/misc/sigma.misc.animation.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/misc/sigma.misc.bindEvents.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/misc/sigma.misc.bindDOMEvents.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/src/misc/sigma.misc.drawHovers.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/plugins/sigma.renderers.edgeLabels/settings.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.def.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curve.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/plugins/sigma.renderers.edgeLabels/sigma.canvas.edges.labels.curvedArrow.js"></script>
  <!-- Sigma plugins -->
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/plugins/sigma.layout.forceAtlas2/supervisor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/plugins/sigma.layout.forceAtlas2/worker.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sigma@1.2.1/plugins/sigma.plugins.relativeSize/sigma.plugins.relativeSize.js"></script>
  <!--CSS-->
  <link rel="stylesheet" href="./style.css">
  <!--jquery-->
  <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
</head>

<body>
  <div style="width:15%;float:right;text-align:left;padding: 12px 18px;">
    <form id="form">
      <label for="txn">Tx Hash:</label><br>
      <input type="text" id="txn" name="txn"><br>
      <div style="padding-top: 18px;">
        <input type="submit" id="submit" name="submit"><br>
      </div>
    </form>
    <div style="padding-top: 18px;">
      <span>Tainted Transactions<div class="dot" style="background-color: #000000;"></div></span>
      <span>Input/Output Transactions<div class="dot" style="background-color: #EE651D;"></div>
    </div></span>
    <span>UTXOs<div class="dot" style="background-color: #0000FF;"></div></span>


  </div>
  </div>
  <div id='sigma-container'></div>
  <div style="padding-top: 18px;" id='details'></div>
</body>

<script>
  var blacklist = [], edges = 0, nodeList = [];

  var s = new sigma(
    {
      renderer: {
        container: document.getElementById('sigma-container'),
        type: 'canvas',
      },
      settings: {
        edgeLabelSize: 'proportional',
        drawEdgeLabels: false,
        minArrowSize: 10,
        labelThreshold: 100,
        borderSize: 2,
        outerBorderSize: 3,
        defaultNodeOuterBorderColor: 'rgb(236, 81, 72)',
        enableEdgeHovering: true,
        edgeHoverHighlightNodes: 'circle',
        sideMargin: 1,
        edgeHoverColor: 'red',
        defaultEdgeHoverColor: '#fff',
        edgeHoverSizeRatio: 1,
        edgeHoverExtremities: true,
        drawEdgeLabels: true,
      }
    }
  );

  $("#submit").click(function (e) {
    e.preventDefault();
    
    var txn_hash = document.getElementById('txn').value;
    console.log(txn_hash);
    // document.getElementById('txn').value = "";
    
    s.graph.clear();
    s.graph.read({
      nodes: [],
      edges: []
    });
    blacklist = [];
    edges = 0;
    nodeList = [];
    
    extendGraph(txn_hash);
  });

  function txns_to_new_graph_using_nodelist(txns) {
    var graph = {
      nodes: [],
      edges: []
    };
    for (const txn of txns) {
      if (nodeList.indexOf(txn["hash"]) == -1) {
        nodeList.push(txn["hash"]);
        graph.nodes.push({ id: txn["hash"] });
      }
      var txn_inputs = txn["inputs"];
      var txn_outputs = txn["outputs"];
      for (const tx_input of txn_inputs) {
        var nodeId = tx_input["prev_tx_hash"];
        if(tx_input["sender_address"] == "COINBASE") {
          nodeId = "COINBASE: " + txn["hash"];
        }
        if (nodeList.indexOf(nodeId) == -1) {
          nodeList.push(nodeId);
          graph.nodes.push({ id: nodeId });
          graph.edges.push({ source: nodeId, target: txn["hash"], amount: tx_input["amount"], address: tx_input["sender_address"] });
        }
      }

      for (var j = 0; j < txn_outputs.length; j++) {
        const tx_output = txn_outputs[j];
        var nodeId = tx_output["next_tx_hash"];
        if(tx_output["next_tx_hash"] == "") { // UTXO
          nodeId = "UTXO " + (j + 1) + ": " + txn["hash"];
        }
        if(nodeList.indexOf(nodeId) == -1) {
          nodeList.push(nodeId);
          graph.nodes.push({ id: nodeId });
          graph.edges.push({ source: txn["hash"], target: nodeId, amount: tx_output["amount"], address: tx_output["receiver_address"] });
        }
      }
    }
    return graph;
  }

  function nodeColor(nodeName) {
    if (nodeName[0] == "U") { // UTXO
      return "#0000FF";
    }
    else if (nodeName[0] == "C") { // COINBASE
      return "#FFFF00";
    }
    else return "#EE651D"
  }

  function getData(txn) {
    var dump;
    $.ajax({
      url: "http://127.0.0.1:5000/tx/" + txn,
      async: false,
      dataType: 'json',
      success: function (d) {
        dump = d;
      }
    });
    return dump;
  }

  function extendGraph(txn_hash) {
    var dump = getData(txn_hash);
    if (dump == undefined) {
      return;
    }

    var l = nodeList.length;
    
    var newGraphData = txns_to_new_graph_using_nodelist(dump["txns"]);
    
    if (nodeList.length == l) {
      // no new nodes
      return;
    }

    blacklist = blacklist.concat(dump["blacklist"]);

    for (i = 0; i < newGraphData.nodes.length; i++) {
      s.graph.addNode(getNode(newGraphData.nodes[i]));
    }

    for (i = 0; i < newGraphData.edges.length; i++) {
      s.graph.addEdge(getEdge(newGraphData.edges[i], i + edges));
    }

    s.refresh();
    s.startForceAtlas2();
    window.setTimeout(function () { s.killForceAtlas2() }, 1000);

    edges = edges + newGraphData.edges.length;
  }

  function getNode(nodeData) {
    var radius = 10;
    var x_coord = Math.random() * 2 * radius - radius;
    var ylim = Math.sqrt(radius * radius - x_coord * x_coord);
    var y_coord = Math.random() * 2 * ylim - ylim;
    return {
      id: nodeData["id"],
      label: 'TXN ' + nodeData["id"],
      x: x_coord,
      y: y_coord,
      size: 30,
      color: nodeColor(nodeData["id"])
    };
  }

  function getEdge(edgeData, id) {
    return {
        id: id,
        label: '' + edgeData["amount"],
        source: edgeData["source"],
        target: edgeData["target"],
        color: '#202020',
        type: 'arrow',
        address: edgeData["address"],
      }
  }

  s.bind('clickNode doubleClickNode rightClickNode', function (e) {
    console.log(e.data.node.id, e.type, e.data.node.label, e.data.captor);
    if (e.data.node.color == "#EE651D") { // Neither UTXO nor COINBASE
      extendGraph(e.data.node.id);
    }
  });

  s.bind('overNode', function (e) {
    var label = e.data.node.label;
    // TODO Display Data
  });

  s.bind('overEdge', function (e) { // Doesn't work
    // TODO
    // console.log('overEdge')
    // s.settings('drawEdgeLabels', true)
  })

</script>

</html>